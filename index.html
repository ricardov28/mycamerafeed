<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=yes">
    <title>Display Live Camera Stream</title>
</head>

<body>
    <div id="imageGalleries"></div>

    <script>
        let imageGalleriesElement;
        let latestImages = {};

        const DEVICE_TIMEOUT = 10000; // Time in milliseconds for device timeout

        document.addEventListener("DOMContentLoaded", function (event) {
            imageGalleriesElement = document.getElementById('imageGalleries');

            const res = fetch(`https://fromeventtoweb.azurewebsites.net/api/negotiate?id=${1}`)
                .then(response => response.json())
                .then(data => {
                    const webSocket = new WebSocket(data.url);

                    webSocket.onopen = function onOpen() {
                        console.log('WebSocket connection is open');
                    };

                    webSocket.onclose = function onClose() {
                        console.log('WebSocket connection is closed');
                    };

                    webSocket.onerror = function onError(error) {
                        console.error('WebSocket error:', error);
                    };

                    // Function to capture camera snapshot and send it to WebSocket
                    async function captureAndSendFrame() {
                        try {
                            const videoElement = document.createElement('video');

                            // Request access to the camera
                            const stream = await navigator.mediaDevices.getUserMedia({ video: true });

                            // Attach the video stream to the video element
                            videoElement.srcObject = stream;

                            // Play the video to start capturing frames
                            videoElement.play();

                            // Create a canvas element to draw the video frame
                            const canvas = document.createElement('canvas');
                            canvas.width = videoElement.videoWidth;
                            canvas.height = videoElement.videoHeight;
                            const ctx = canvas.getContext('2d');

                            // Function to send camera frame to WebSocket
                            async function sendFrameToWebSocket() {
                                // Draw the video frame on the canvas
                                ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);

                                // Get the data URL (Base64-encoded) from the canvas
                                const dataURL = canvas.toDataURL('image/jpeg', 0.8); // 0.8 is the JPEG quality (adjust as needed)

                                // Send the Base64-encoded frame data to the WebSocket
                                webSocket.send(JSON.stringify({ image_data: dataURL.split(',')[1] }));
                            }

                            // Send camera frames every 1 second (1fps)
                            setInterval(sendFrameToWebSocket, 1000);
                        } catch (error) {
                            console.error('Error capturing camera stream:', error);
                        }
                    }

                    // Call the function to start capturing and sending frames
                    captureAndSendFrame();
                })
                .catch(error => {
                    console.error('Error fetching WebSocket data:', error);
                });
        });

    </script>
</body>

</html>
