<!DOCTYPE html>
<html>
<head>
  <title>Camera Stream to Azure Event Hub</title>
</head>
<body>
  <h1>Camera Stream</h1>
  <video id="camera-feed" autoplay></video>

  <script src="https://unpkg.com/@azure/event-hubs"></script>
  <script>
    // Azure Event Hub connection string
    const connectionString = "Endpoint=sb://dronepicstandard.servicebus.windows.net/;SharedAccessKeyName=RootManageSharedAccessKey;SharedAccessKey=se+CPdsp34rL8VFmEmicGwy3G72jb62VV+AEhBtvl2k=";
    const eventHubName = "dronerpicamera";

    const videoElement = document.getElementById("camera-feed");

    // Function to handle getUserMedia success
    function handleSuccess(stream) {
      videoElement.srcObject = stream;

      // Create an Event Hub client
      const client = new EventHubs.EventHubProducerClient(connectionString, eventHubName);

      // Function to send camera frames to Azure Event Hub
      async function sendFrame(frame) {
        try {
          const data = { frame: frame };
          await client.sendBatch([{ body: JSON.stringify(data) }]);
        } catch (error) {
          console.error("Error sending frame to Event Hub:", error);
        }
      }

      // Start capturing camera frames and send them to Azure Event Hub
      const mediaRecorder = new MediaRecorder(stream);
      mediaRecorder.ondataavailable = (event) => {
        const reader = new FileReader();
        reader.onload = () => {
          const frameData = reader.result.split(",")[1];
          sendFrame(frameData); // Sending the frame to Event Hub
        };
        reader.readAsDataURL(event.data);
      };

      // Start recording
      mediaRecorder.start();
    }

    // Function to handle getUserMedia error
    function handleError(error) {
      console.error("Error accessing the camera:", error);
    }

    // Check if getUserMedia is available in the browser
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
      // Request access to the camera
      navigator.mediaDevices
        .getUserMedia({ video: true })
        .then(handleSuccess)
        .catch(handleError);
    } else {
      console.error("getUserMedia is not available in this browser.");
    }
  </script>
</body>
</html>
