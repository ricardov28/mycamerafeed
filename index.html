<!DOCTYPE html>
<html>
<head>
  <title>Camera Stream to Azure Functions</title>
</head>
<body>
  <h1>Camera Stream</h1>
  <video id="camera-feed" autoplay></video>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.23.0/axios.min.js"></script>
  <script>
    let webPubSubToken = null;

    // Function to handle getUserMedia success
    function handleSuccess(stream) {
      const videoElement = document.getElementById("camera-feed");
      videoElement.srcObject = stream;

      // Create a canvas element to draw the video frame
      const canvas = document.createElement("canvas");
      canvas.width = videoElement.videoWidth;
      canvas.height = videoElement.videoHeight;
      const ctx = canvas.getContext("2d");

      // Function to send camera frame to the Azure Functions
      async function sendFrameToFunctions(frameData) {
        try {
          if (!webPubSubToken) {
            // Fetch the Web PubSub token from the Azure Function
            const negotiateResponse = await axios.get("https://fromwebsitetowebpubsub.azurewebsites.net/api/negotiate");
            webPubSubToken = negotiateResponse.data.token;
          }

          // Send the camera frame to the Azure Function using the Web PubSub token
          const functionEndpoint = "https://fromwebsitetowebpubsub.azurewebsites.net/api/processmessage";
          const headers = {
            "Authorization": `Bearer ${webPubSubToken}`,
            "Content-Type": "application/json",
          };
          const data = { frame: frameData };

          await axios.post(functionEndpoint, data, { headers });
        } catch (error) {
          console.error("Error sending frame to the Azure Function:", error);
        }
      }

      // Start capturing camera frames and send them to the Azure Functions at 1 fps
      const mediaRecorder = new MediaRecorder(stream);
      let sendInterval;

      mediaRecorder.onstart = () => {
        sendInterval = setInterval(() => {
          // Draw the video frame on the canvas
          ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
          // Get the JPEG data from the canvas
          const jpegData = canvas.toDataURL("image/jpeg");
          // Send the frame data to the Azure Functions
          sendFrameToFunctions(jpegData.split(",")[1]);
        }, 1000); // Send frames every 1000 milliseconds (1 second)
      };

      mediaRecorder.onstop = () => {
        clearInterval(sendInterval);
      };

      // Start recording
      mediaRecorder.start();
    }

    // Function to handle getUserMedia error
    function handleError(error) {
      console.error("Error accessing the camera:", error);
    }

    // Check if getUserMedia is available in the browser
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
      // Request access to the camera
      navigator.mediaDevices
        .getUserMedia({ video: true })
        .then(handleSuccess)
        .catch(handleError);
    } else {
      console.error("getUserMedia is not available in this browser.");
    }
  </script>
</body>
</html>
