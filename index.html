<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=yes">
    <title>Display Live Camera Stream</title>
</head>

<body>
    <div id="imageGalleries"></div>

    <script>
        let imageGalleriesElement;
        let latestImages = {};

        const DEVICE_TIMEOUT = 10000; // Time in milliseconds for device timeout
        let webSocket;

        document.addEventListener("DOMContentLoaded", function (event) {
            imageGalleriesElement = document.getElementById('imageGalleries');

            // Function to open WebSocket
            async function connectWebSocket() {
                try {
                    const res = await fetch(`https://fromeventtoweb.azurewebsites.net/api/negotiate?id=${1}`);
                    const data = await res.json();
                    webSocket = new WebSocket(data.url);

                    webSocket.onopen = function onOpen() {
                        console.log('WebSocket connection is open');
                    };

                    webSocket.onerror = function onError(error) {
                        console.error('WebSocket error:', error);
                    };

                    // Start capturing and sending frames after the WebSocket is open
                    captureAndSendFrame();
                } catch (error) {
                    console.error('Error fetching WebSocket data:', error);
                }
            }

            // Call the function to open WebSocket
            connectWebSocket();
        });

        // Function to capture camera snapshot and send it to WebSocket
        async function captureAndSendFrame() {
            try {
                const videoElement = document.createElement('video');

                // Request access to the camera
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });

                // Attach the video stream to the video element
                videoElement.srcObject = stream;

                // Play the video to start capturing frames
                videoElement.play();

                // Wait for the video to be fully loaded
                await new Promise(resolve => videoElement.onloadeddata = resolve);

                // Create a canvas element to draw the video frame
                const canvas = document.createElement('canvas');
                canvas.width = videoElement.videoWidth;
                canvas.height = videoElement.videoHeight;
                const ctx = canvas.getContext('2d');

                // Function to capture and send camera frame to WebSocket
                function captureAndSendFrame() {
                    // Draw the video frame on the canvas
                    ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);

                    // Get the data URL (Base64-encoded) from the canvas
                    const dataURL = canvas.toDataURL('image/jpeg', 0.8); // 0.8 is the JPEG quality (adjust as needed)

                    // Create a Blob object from the data URL
                    const blob = dataURLToBlob(dataURL);

                    // Use FileReader to read the Blob as data URL
                    const reader = new FileReader();
                    reader.readAsDataURL(blob);
                    reader.onloadend = function () {
                        // Send the Base64-encoded frame data to the WebSocket
                        if (webSocket.readyState === WebSocket.OPEN) {
                            webSocket.send(JSON.stringify({ image_data: reader.result }));
                        }
                    };
                }

                // Display the camera frame in the website
                function displayFrame(dataURL) {
                    // Create the image element for the latest snapshot
                    const imageElement = document.createElement('img');
                    imageElement.src = dataURL;
                    imageElement.style.width = '40%'; // Set the maximum width for the image
                    imageElement.style.height = 'auto'; // Set the maximum height for the image

                    // Create the container element
                    const containerElement = document.createElement('div');
                    containerElement.appendChild(imageElement);

                    // Add the container element to the image galleries
                    imageGalleriesElement.appendChild(containerElement);
                }

                // Capture and send camera frames every 1 second (1fps)
                setInterval(async function () {
                    captureAndSendFrame();
                    // Get the data URL (Base64-encoded) from the canvas and display it in the website
                    displayFrame(canvas.toDataURL('image/jpeg', 0.8));
                }, 1000);
            } catch (error) {
                console.error('Error capturing camera stream:', error);
            }
        }

        // Function to convert data URL to Blob
        function dataURLToBlob(dataURL) {
            const arr = dataURL.split(',');
            const mime = arr[0].match(/:(.*?);/)[1];
            const bstr = atob(arr[1]);
            let n = bstr.length;
            const u8arr = new Uint8Array(n);
            while (n--) {
                u8arr[n] = bstr.charCodeAt(n);
            }
            return new Blob([u8arr], { type: mime });
        }

    </script>
</body>

</html>
